# 投資バックテストシミュレーター 仕様書

## 1. 概要

本アプリケーションは、インデックスファンドやETFなどの金融商品に対する積立投資のバックテストを行うためのWebアプリケーションである。
ユーザーが指定した複数の銘柄、投資期間、投資額に基づき、過去のデータを用いたシミュレーションを実行し、そのパフォーマンスを評価する。

## 2. プロジェクト構成

- **言語**: Java 11
- **フレームワーク**: Spring Boot 2.7.0
- **ビルドツール**: Maven
- **フロントエンド**: HTML, CSS, JavaScript, Bootstrap, Chart.js
- **主要ライブラリ**:
  - `spring-boot-starter-web`: Webアプリケーション開発
  - `spring-boot-starter-thymeleaf`: テンプレートエンジン
  - `lombok`: ボイラープレートコード削減
  - `jackson-databind`: JSONデータ処理
  - `RestTemplate`: 外部APIへのHTTPリクエスト

## 3. 機能仕様

### 3.1. バックテスト条件入力

ユーザーはWeb UI上で以下の条件を指定する。

- **投資期間**:
  - 開始日 (YYYY-MM-DD形式)
  - 終了日 (YYYY-MM-DD形式)
- **投資銘柄**:
  - 最大5銘柄まで追加可能。
  - 各銘柄に対して以下を設定する。
    - **銘柄コード**: プルダウンメニューから選択する。
      - `stooq.com` で提供されているシンボルに対応。
      - (例: `^SPX` (S&P 500), `^NDX` (NASDAQ 100), `XAUUSD` (金))
    - **初期投資額**: シミュレーション開始時の投資額。
    - **毎月の積立額**: 毎月、月初に買い増しを行う投資額。

### 3.2. バックテスト実行

1.  「バックテスト実行」ボタンをクリックすると、入力された条件がサーバーの `/backtest` エンドポイントにPOSTリクエストとして送信される。
2.  サーバーはリクエストを受け取り、`BacktestService` を呼び出してシミュレーション処理を開始する。

### 3.3. シミュレーションロジック (`BacktestService`)

1.  **データ取得**:
    - 各銘柄について、外部データソース `stooq.com` から指定された期間の日次価格データをCSV形式で取得する。
    - APIエンドポイント: `https://stooq.com/q/d/l/?s={銘柄コード}&d1={開始日}&d2={終了日}&i=d`
    - データ取得に失敗した場合やデータが存在しない場合は、エラーを返す。
2.  **シミュレーション**:
    - 取得した価格データを日付昇順にソートする。
    - **初期投資**: シミュレーション開始日の終値で、`初期投資額` 分の資産を購入する。
    - **積立投資**: 期間中、月が変わるごとの最初の営業日の終値で、`毎月の積立額` 分の資産を買い増す。
    - **評価額計算**: 日々の保有資産の評価額を計算し、記録する。
3.  **パフォーマンス指標計算**:
    - シミュレーション結果に基づき、以下の指標を計算する。
      - **総投資額**: `初期投資額` + (`毎月の積立額` * 積立回数)
      - **最終ポートフォリオ価値**: シミュレーション終了日の評価額。
      - **トータルリターン**: `((最終価値 - 総投資額) / 総投資額) * 100`
      - **年率リターン (CAGR)**: `( (1 + トータルリターン/100) ^ (1 / 投資年数) - 1 ) * 100`
      - **シャープレシオ**: `(年率リターン - 無リスク金利) / 年率リスク (ボラティリティ)`
        - 本アプリケーションでは、無リスク金利を0として計算する。
        - 年率リスクは、キャッシュフロー（追加入金）を考慮した日次リターンの標準偏差を年率換算 (`標準偏差 * sqrt(252)`) して求める。

### 3.4. 結果表示

サーバーは計算結果をJSON形式でクライアントに返す。クライアントは受け取ったデータを整形し、以下の形式で表示する。

- **サマリーテーブル**:
  - 各銘柄ごと、および全銘柄を合算したポートフォリオのパフォーマンス指標（総投資額、最終価値、リターン、年率リターン、シャープレシオ）を表で表示する。
- **最終資産配分グラフ**:
  - 複数銘柄を指定した場合、最終日時点での各銘柄の評価額の割合を円グラフで表示する。
- **ポートフォリオ推移グラフ**:
  - シミュレーション期間中のポートフォリオ評価額の推移を折れ線グラフで表示する。
  - 累計投資額の推移も同グラフ上に表示され、元本と評価額の関係を視覚的に比較できる。

## 4. API仕様

### `POST /backtest`

- **説明**: バックテストを実行する。
- **リクエストボディ**:
  ```json
  {
    "startDate": "2020-01-01",
    "endDate": "2023-12-31",
    "symbols": [
      {
        "symbol": "^SPX",
        "initialInvestment": 10000,
        "monthlyInvestment": 100
      },
      {
        "symbol": "^NDX",
        "initialInvestment": 5000,
        "monthlyInvestment": 50
      }
    ]
  }
  ```
- **レスポンスボディ (成功時)**:
  ```json
  {
    "results": [
      {
        "symbol": "^SPX",
        "totalInvestment": 14800.0,
        "finalValue": 20000.0,
        "totalReturn": 35.13,
        "annualizedReturn": 8.0,
        "sharpeRatio": 0.85,
        "monthlyData": [
          {"date": "2020-01-31", "investment": 10100.0, "portfolioValue": 10200.0},
          ...
        ]
      },
      ...
    ],
    "combinedResult": {
      "totalInvestment": 22200.0,
      "finalValue": 31000.0,
      "totalReturn": 39.64,
      "annualizedReturn": 8.8,
      "sharpeRatio": 0.92,
      "monthlyData": [
        {"date": "2020-01-31", "investment": 15150.0, "portfolioValue": 15350.0},
        ...
      ]
    }
  }
  ```
- **レスポンス (エラー時)**:
  - ステータスコード: 500 Internal Server Error
  - ボディ:
    ```json
    {
      "message": "銘柄「XXX」のデータが、選択された期間に見つかりませんでした。..."
    }
    ```

## 5. 画面仕様

`index.html` にて実装。Bootstrap 5 を用いたレスポンシブデザイン。

- **ヘッダー**: 「投資バックテストシミュレーター」というタイトルを表示。
- **入力フォーム**:
  - 期間設定（開始日、終了日）
  - 銘柄追加ボタン
  - 動的に追加される銘柄入力欄（銘柄選択、初期投資額、毎月の積立額）
  - バックテスト実行ボタン
- **結果表示エリア**:
  - エラーメッセージ表示領域
  - 結果サマリーテーブル
  - 資産配分円グラフ
  - ポートフォリオ推移折れ線グラフ

## 6. 注意事項・制約

- 株価データは `stooq.com` に依存しているため、同サイトの仕様変更や停止の影響を受ける。
- 配当金や取引手数料はシミュレーションに含まれていない。
- 為替レートの変動は考慮されていない（すべて米ドルベースと仮定）。
- シミュレーションは過去のデータに基づくものであり、将来のパフォーマンスを保証するものではない。 